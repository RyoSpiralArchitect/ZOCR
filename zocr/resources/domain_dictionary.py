"""Domain-specific keyword dictionaries for the built-in toy OCR lexicon."""
from __future__ import annotations

from typing import Dict, Iterable, Optional, Set

DOMAIN_KEYWORDS: Dict[str, Set[str]] = {
    "invoice_ja": {
        "請求書",
        "御請求書",
        "請求日",
        "請求番号",
        "請求先",
        "御請求金額",
        "請求金額",
        "合計金額",
        "小計",
        "消費税",
        "税率",
        "支払期日",
        "振込先",
        "摘要",
        "数量",
        "単価",
        "金額",
        "発行日",
    },
    "invoice_en": {
        "invoice",
        "invoice number",
        "bill to",
        "ship to",
        "customer",
        "amount due",
        "total due",
        "total amount",
        "subtotal",
        "tax",
        "tax amount",
        "due date",
        "line item",
        "quantity",
        "unit price",
        "balance",
        "payment terms",
    },
    "purchase_order_ja": {
        "発注書",
        "御発注書",
        "発注番号",
        "注文日",
        "納期",
        "納入場所",
        "仕入先",
        "品番",
        "品名",
        "数量",
        "単価",
        "金額",
        "担当者",
        "承認",
    },
    "purchase_order_en": {
        "purchase order",
        "po number",
        "order date",
        "vendor",
        "supplier",
        "ship to",
        "bill to",
        "item",
        "sku",
        "quantity",
        "unit price",
        "amount",
        "requested by",
        "approval",
    },
    "medical_bill_ja": {
        "診療明細",
        "診療科",
        "患者氏名",
        "保険者",
        "被保険者番号",
        "自己負担",
        "点数",
        "投薬",
        "手術",
        "入院",
        "外来",
        "領収済",
    },
    "medical_bill_en": {
        "medical bill",
        "patient",
        "provider",
        "policy number",
        "diagnosis",
        "procedure",
        "cpt",
        "icd",
        "copay",
        "deductible",
        "amount billed",
        "insurance",
    },
    "customs_declaration_ja": {
        "輸入申告",
        "輸出申告",
        "通関",
        "税関",
        "課税価格",
        "仕向地",
        "仕出地",
        "原産国",
        "HSコード",
        "輸送手段",
        "重量",
        "関税",
    },
    "customs_declaration_en": {
        "customs declaration",
        "importer",
        "exporter",
        "hs code",
        "tariff",
        "duty",
        "origin country",
        "port of entry",
        "gross weight",
        "net weight",
        "invoice value",
        "freight",
    },
    "grant_application_ja": {
        "助成金",
        "交付申請",
        "事業計画",
        "研究計画",
        "申請者",
        "代表者",
        "所属",
        "予算",
        "支出計画",
        "成果目標",
    },
    "grant_application_en": {
        "grant application",
        "funding request",
        "principal investigator",
        "project summary",
        "budget",
        "milestone",
        "deliverable",
        "reviewer",
        "award amount",
        "timeline",
    },
    "boarding_pass_ja": {
        "搭乗券",
        "便名",
        "搭乗口",
        "搭乗時刻",
        "出発時刻",
        "到着時刻",
        "座席番号",
        "搭乗日",
        "航空券",
    },
    "boarding_pass_en": {
        "boarding pass",
        "flight",
        "gate",
        "boarding time",
        "departure",
        "arrival",
        "seat",
        "pnr",
        "record locator",
    },
    "rental_agreement_ja": {
        "賃貸借契約書",
        "契約期間",
        "賃料",
        "敷金",
        "礼金",
        "管理費",
        "更新料",
        "物件住所",
        "甲",
        "乙",
    },
    "rental_agreement_en": {
        "lease agreement",
        "rental agreement",
        "tenant",
        "landlord",
        "rent",
        "deposit",
        "security deposit",
        "premises",
        "lease term",
        "renewal",
    },
    "loan_statement_ja": {
        "返済予定表",
        "元金",
        "利息",
        "返済額",
        "残高",
        "償還",
        "返済期日",
        "ボーナス払い",
        "借入金",
    },
    "loan_statement_en": {
        "loan statement",
        "principal",
        "interest",
        "installment",
        "payment date",
        "maturity",
        "amortization",
        "balance",
        "escrow",
    },
    "travel_itinerary_ja": {
        "旅程",
        "出発地",
        "到着地",
        "経由地",
        "予約番号",
        "宿泊",
        "ホテル",
        "便名",
        "集合時刻",
        "観光",
    },
    "travel_itinerary_en": {
        "itinerary",
        "departure",
        "arrival",
        "layover",
        "booking reference",
        "confirmation number",
        "hotel",
        "check-in",
        "check-out",
        "tour",
    },
    "bank_statement_ja": {
        "取引明細",
        "口座番号",
        "支店",
        "振込",
        "入金",
        "出金",
        "引落",
        "残高",
        "利息",
        "摘要",
    },
    "bank_statement_en": {
        "bank statement",
        "account number",
        "routing",
        "deposit",
        "withdrawal",
        "transaction",
        "balance",
        "interest",
        "statement period",
        "available balance",
    },
    "utility_bill_ja": {
        "ご使用量",
        "電気料金",
        "ガス料金",
        "水道料金",
        "検針日",
        "契約種別",
        "請求金額",
        "支払期限",
        "基本料金",
        "従量料金",
    },
    "utility_bill_en": {
        "utility bill",
        "meter reading",
        "usage",
        "billing period",
        "service address",
        "rate plan",
        "amount due",
        "due date",
        "kwh",
        "therms",
    },
    "insurance_claim_ja": {
        "保険金請求",
        "被保険者",
        "保険証券",
        "事故日",
        "診断書",
        "給付金",
        "支払額",
        "担当者",
        "通知",
    },
    "insurance_claim_en": {
        "insurance claim",
        "policy number",
        "insured",
        "claim number",
        "incident date",
        "adjuster",
        "coverage",
        "payout",
        "medical report",
        "settlement",
    },
    "tax_form_ja": {
        "確定申告",
        "課税所得",
        "控除額",
        "源泉徴収",
        "税額控除",
        "所得区分",
        "扶養控除",
        "住民税",
        "申告区分",
    },
    "tax_form_en": {
        "tax form",
        "taxpayer",
        "filing status",
        "taxable income",
        "deduction",
        "withholding",
        "refund",
        "credits",
        "dependents",
        "adjusted gross income",
    },
    "payslip_ja": {
        "給与明細",
        "支給額",
        "基本給",
        "控除",
        "社会保険",
        "厚生年金",
        "所得税",
        "差引支給額",
        "勤怠",
        "残業",
    },
    "payslip_en": {
        "payslip",
        "pay stub",
        "gross pay",
        "net pay",
        "deductions",
        "benefits",
        "overtime",
        "hours worked",
        "tax",
        "withholding",
    },
    "shipping_notice_ja": {
        "出荷案内",
        "納品書",
        "発送",
        "出荷日",
        "納品日",
        "配送業者",
        "追跡番号",
        "数量",
        "品番",
        "受領印",
    },
    "shipping_notice_en": {
        "shipping notice",
        "shipment",
        "delivery",
        "ship date",
        "carrier",
        "tracking",
        "packing list",
        "item",
        "quantity",
        "received",
    },
    "expense_report_ja": {
        "経費精算",
        "申請日",
        "立替金",
        "交通費",
        "宿泊費",
        "交際費",
        "領収書",
        "承認者",
        "申請者",
        "精算金額",
    },
    "expense_report_en": {
        "expense report",
        "reimbursement",
        "employee",
        "category",
        "receipt",
        "amount",
        "approved by",
        "submit date",
        "travel",
        "meals",
    },
}

DOMAIN_GROUPS: Dict[str, Set[str]] = {
    "invoice": {"invoice_ja", "invoice_en"},
    "purchase_order": {"purchase_order_ja", "purchase_order_en"},
    "medical_bill": {"medical_bill_ja", "medical_bill_en"},
    "customs_declaration": {"customs_declaration_ja", "customs_declaration_en"},
    "grant_application": {"grant_application_ja", "grant_application_en"},
    "boarding_pass": {"boarding_pass_ja", "boarding_pass_en"},
    "rental_agreement": {"rental_agreement_ja", "rental_agreement_en"},
    "loan_statement": {"loan_statement_ja", "loan_statement_en"},
    "travel_itinerary": {"travel_itinerary_ja", "travel_itinerary_en"},
    "bank_statement": {"bank_statement_ja", "bank_statement_en"},
    "utility_bill": {"utility_bill_ja", "utility_bill_en"},
    "insurance_claim": {"insurance_claim_ja", "insurance_claim_en"},
    "tax_form": {"tax_form_ja", "tax_form_en"},
    "payslip": {"payslip_ja", "payslip_en"},
    "shipping_notice": {"shipping_notice_ja", "shipping_notice_en"},
    "expense_report": {"expense_report_ja", "expense_report_en"},
}

DOMAIN_ALIASES: Dict[str, str] = {
    "invoice_jp": "invoice_ja",
    "invoice_jp_v2": "invoice_ja",
    "invoice_en_v2": "invoice_en",
    "purchase_order_en": "purchase_order_en",
    "purchase_order_jp": "purchase_order_ja",
    "medical_bill_en": "medical_bill_en",
    "medical_bill_jp": "medical_bill_ja",
    "customs_declaration_en": "customs_declaration_en",
    "customs_declaration_jp": "customs_declaration_ja",
    "grant_application_en": "grant_application_en",
    "grant_application_jp": "grant_application_ja",
    "boarding_pass_en": "boarding_pass_en",
    "boarding_pass_jp": "boarding_pass_ja",
    "rental_agreement_en": "rental_agreement_en",
    "rental_agreement_jp": "rental_agreement_ja",
    "loan_statement_en": "loan_statement_en",
    "loan_statement_jp": "loan_statement_ja",
    "travel_itinerary_en": "travel_itinerary_en",
    "travel_itinerary_jp": "travel_itinerary_ja",
    "bank_statement_en": "bank_statement_en",
    "bank_statement_jp": "bank_statement_ja",
    "utility_bill_en": "utility_bill_en",
    "utility_bill_jp": "utility_bill_ja",
    "insurance_claim_en": "insurance_claim_en",
    "insurance_claim_jp": "insurance_claim_ja",
    "tax_form_en": "tax_form_en",
    "tax_form_jp": "tax_form_ja",
    "payslip_en": "payslip_en",
    "payslip_jp": "payslip_ja",
    "shipping_notice_en": "shipping_notice_en",
    "shipping_notice_jp": "shipping_notice_ja",
    "expense_report_en": "expense_report_en",
    "expense_report_jp": "expense_report_ja",
}

_ALL_KEYWORDS: Set[str] = set()
for values in DOMAIN_KEYWORDS.values():
    _ALL_KEYWORDS.update(values)

ALL_KEYWORDS: Set[str] = set(_ALL_KEYWORDS)


def _iter_group_keywords(domain: str) -> Iterable[str]:
    for member in DOMAIN_GROUPS.get(domain, set()):
        yield from DOMAIN_KEYWORDS.get(member, set())


def get_domain_keywords(domain: Optional[str]) -> Set[str]:
    """Return the keyword set for a domain (falls back to the global lexicon)."""
    if not domain:
        return set(ALL_KEYWORDS)
    token = domain.strip().lower()
    token = DOMAIN_ALIASES.get(token, token)
    keywords: Set[str] = set()
    if token in DOMAIN_KEYWORDS:
        keywords.update(DOMAIN_KEYWORDS[token])
    if token in DOMAIN_GROUPS:
        keywords.update(_iter_group_keywords(token))
    if not keywords:
        return set(ALL_KEYWORDS)
    return keywords


def all_domain_keywords() -> Dict[str, Set[str]]:
    """Expose a mapping from domain tokens to their keyword sets."""
    mapping: Dict[str, Set[str]] = {}
    for domain, members in DOMAIN_GROUPS.items():
        bucket: Set[str] = set()
        for member in members:
            bucket.update(DOMAIN_KEYWORDS.get(member, set()))
        if bucket:
            mapping[domain] = bucket
    for domain, keywords in DOMAIN_KEYWORDS.items():
        mapping.setdefault(domain, set()).update(keywords)
    return mapping


__all__ = [
    "DOMAIN_KEYWORDS",
    "DOMAIN_GROUPS",
    "DOMAIN_ALIASES",
    "ALL_KEYWORDS",
    "get_domain_keywords",
    "all_domain_keywords",
]
